import pygame
import math


class NPC:
    """NPCç±»"""
    
    def __init__(self, name, x, y, dialogue, has_shop=False, map_type='æ‘åº„', npc_type='æ™®é€š'):
        """åˆå§‹åŒ–NPC"""
        self.name = name
        self.x, self.y = x, y
        self.dialogue = dialogue
        self.has_shop = has_shop
        self.map_type = map_type  # åœ°å›¾ç±»å‹
        self.npc_type = npc_type  # NPCç±»å‹
        
        # ä¸ªæ€§åŒ–å±æ€§
        self.personality = "å‹å¥½"  # æ€§æ ¼
        self.background = "æ™®é€šæ‘æ°‘"  # èƒŒæ™¯æ•…äº‹
        self.level = 1  # ç­‰çº§
        self.skills = []  # æŠ€èƒ½
        self.mood = "æ­£å¸¸"  # å¿ƒæƒ…
        self.relationships = {}  # ä¸ç©å®¶çš„å…³ç³»
        self.memories = []  # ä¸ç©å®¶çš„äº’åŠ¨è®°å¿†
        self.daily_routine = []  # æ—¥å¸¸è¡Œä¸º
        
        # å¤šè½®å¯¹è¯ç³»ç»Ÿ
        self.dialogue_history = []
        self.current_dialogue_index = 0
        self.contextual_dialogue = []  # ä¸Šä¸‹æ–‡ç›¸å…³å¯¹è¯
        
        # æ ¹æ®åœ°å›¾ç±»å‹å’ŒNPCç±»å‹åˆå§‹åŒ–å•†åº—ç‰©å“
        self._initialize_shop_items()
        
        # æ ¹æ®åœ°å›¾ç±»å‹å’ŒNPCç±»å‹è®¾ç½®ä¸ªæ€§åŒ–å±æ€§
        self._set_personal_attributes()
        
        # åˆå§‹åŒ–æ—¥å¸¸è¡Œä¸º
        self._initialize_daily_routine()
        
        # åˆå§‹åŒ–ä¸Šä¸‹æ–‡å¯¹è¯
        self._initialize_contextual_dialogue()
    
    def _initialize_shop_items(self):
        """æ ¹æ®åœ°å›¾ç±»å‹å’ŒNPCç±»å‹åˆå§‹åŒ–å•†åº—ç‰©å“"""
        if self.has_shop:
            if self.map_type == 'æ‘åº„':
                if self.npc_type == 'æ­¦å™¨å•†':
                    self.shop_items = [
                        {'name': 'æœ¨å‰‘', 'price': 100, 'quantity': 1},
                        {'name': 'é“å‰‘', 'price': 300, 'quantity': 1},
                        {'name': 'é“œå‰‘', 'price': 500, 'quantity': 1},
                        {'name': 'é‡‘ç–®è¯', 'price': 50, 'quantity': 99},
                        {'name': 'é­”æ³•è¯', 'price': 80, 'quantity': 99}
                    ]
                elif self.npc_type == 'è¯åº—è€æ¿':
                    self.shop_items = [
                        {'name': 'é‡‘ç–®è¯', 'price': 40, 'quantity': 99},
                        {'name': 'é­”æ³•è¯', 'price': 70, 'quantity': 99},
                        {'name': 'è¶…çº§é‡‘ç–®è¯', 'price': 100, 'quantity': 99},
                        {'name': 'è¶…çº§é­”æ³•è¯', 'price': 150, 'quantity': 99}
                    ]
                elif self.npc_type == 'é˜²å…·å•†':
                    self.shop_items = [
                        {'name': 'å¸ƒè¡£', 'price': 150, 'quantity': 1},
                        {'name': 'é“ç”²', 'price': 400, 'quantity': 1},
                        {'name': 'é“œç”²', 'price': 600, 'quantity': 1},
                        {'name': 'çš®å¸½', 'price': 80, 'quantity': 1},
                        {'name': 'é“å¤´ç›”', 'price': 200, 'quantity': 1},
                        {'name': 'è‰é‹', 'price': 50, 'quantity': 1},
                        {'name': 'é“é´', 'price': 150, 'quantity': 1}
                    ]
            elif self.map_type == 'æ£®æ—':
                self.shop_items = [
                    {'name': 'æœ¨å‰‘', 'price': 80, 'quantity': 1},
                    {'name': 'çš®ç”²', 'price': 200, 'quantity': 1},
                    {'name': 'å¼“ç®­', 'price': 300, 'quantity': 1},
                    {'name': 'é‡‘ç–®è¯', 'price': 60, 'quantity': 99}
                ]
            elif self.map_type == 'æ²™æ¼ ':
                self.shop_items = [
                    {'name': 'å¼¯åˆ€', 'price': 400, 'quantity': 1},
                    {'name': 'æ²™æ¼ ä¹‹é´', 'price': 250, 'quantity': 1},
                    {'name': 'é˜²æ™’å¤´å·¾', 'price': 150, 'quantity': 1},
                    {'name': 'é­”æ³•è¯', 'price': 60, 'quantity': 99}
                ]
            elif self.map_type == 'åœ°ç‰¢':
                self.shop_items = [
                    {'name': 'ç”Ÿé”ˆçš„å‰‘', 'price': 150, 'quantity': 1},
                    {'name': 'éª·é«…éª¨ç›¾', 'price': 300, 'quantity': 1},
                    {'name': 'è¶…çº§é‡‘ç–®è¯', 'price': 120, 'quantity': 99},
                    {'name': 'ç«æŠŠ', 'price': 20, 'quantity': 99}
                ]
            else:
                # é»˜è®¤å•†åº—ç‰©å“
                self.shop_items = [
                    {'name': 'é‡‘ç–®è¯', 'price': 50, 'quantity': 99},
                    {'name': 'é­”æ³•è¯', 'price': 80, 'quantity': 99},
                    {'name': 'æœ¨å‰‘', 'price': 100, 'quantity': 1},
                    {'name': 'å¸ƒè¡£', 'price': 150, 'quantity': 1}
                ]
        else:
            self.shop_items = []
    
    def _set_personal_attributes(self):
        """æ ¹æ®åœ°å›¾ç±»å‹å’ŒNPCç±»å‹è®¾ç½®ä¸ªæ€§åŒ–å±æ€§"""
        # æ€§æ ¼ç±»å‹å®šä¹‰
        personality_types = {
            'æ‘åº„': {
                'æ‘é•¿': ('æ…ˆç¥¥', 'æ‘åº„çš„é¢†å¯¼è€…ï¼Œå¾·é«˜æœ›é‡', ['é¢†å¯¼', 'å¤–äº¤'], 'æ­£å¸¸'),
                'æ­¦å™¨å•†': ('è±ªçˆ½', 'æ›¾ç»æ˜¯ä¸€åæˆ˜å£«ï¼Œç°åœ¨æ”¹è¡Œåšç”Ÿæ„', ['é”»é€ ', 'æˆ˜æ–—'], 'ç§¯æ'),
                'è¯åº—è€æ¿': ('ç»†å¿ƒ', 'ç²¾é€šè‰è¯å­¦ï¼Œä¸ºäººå–„è‰¯', ['è‰è¯å­¦', 'åŒ»æœ¯'], 'æ¸©å’Œ'),
                'é˜²å…·å•†': ('ç²¾æ˜', 'æ¥è‡ªå¤§åŸå¸‚çš„å•†äººï¼Œçœ¼å…‰ç‹¬åˆ°', ['ç»å•†', 'è£ç¼'], 'è°¨æ…'),
                'é“åŒ ': ('ç²—çŠ·', 'ä¸–ä»£æ‰“é“ï¼Œæ‰‹è‰ºç²¾æ¹›', ['é”»é€ ', 'ä¿®ç†'], 'ç›´ç‡'),
                'æ³•å¸ˆ': ('ç¥ç§˜', 'æ¥è‡ªè¿œæ–¹çš„é­”æ³•å¸ˆï¼ŒçŸ¥è¯†æ¸Šåš', ['é­”æ³•', 'å åœ'], 'å¹³é™'),
                'ç‰§å¸ˆ': ('è™”è¯š', 'æ‘åº„æ•™å ‚çš„ç‰§å¸ˆï¼Œä¿¡ä»°åšå®š', ['æ²»æ„ˆ', 'ç¥ç¦'], 'ç¥åœ£'),
                'å¨å¸ˆ': ('çƒ­æƒ…', 'æ‘åº„é…’é¦†çš„å¨å¸ˆï¼Œæ“…é•¿çƒ¹é¥ª', ['çƒ¹é¥ª', 'é…¿é…’'], 'æ¬¢å¿«'),
                'æ¸”å¤«': ('æ‚ é—²', 'ä»¥æ•é±¼ä¸ºç”Ÿï¼Œæ€§æ ¼å¼€æœ—', ['é’“é±¼', 'æ¸¸æ³³'], 'è½»æ¾'),
                'çŒäºº': ('æ•é”', 'æ‘åº„çš„çŒäººï¼Œç†Ÿæ‚‰å±±æ—', ['ç‹©çŒ', 'è¿½è¸ª'], 'ä¸“æ³¨'),
                'åŒ»ç”Ÿ': ('ä¸“ä¸š', 'æ‘åº„çš„åŒ»ç”Ÿï¼Œæ•‘æ­»æ‰¶ä¼¤', ['åŒ»æœ¯', 'è¯Šæ–­'], 'å†·é™'),
                'æ•™å¸ˆ': ('åšå­¦', 'æ‘åº„çš„æ•™å¸ˆï¼Œæ•™ä¹¦è‚²äºº', ['çŸ¥è¯†', 'æ•™è‚²'], 'æ¸©å’Œ'),
                'å•†äºº': ('åœ†æ»‘', 'æ¸¸èµ°å„åœ°çš„å•†äººï¼Œè§å¤šè¯†å¹¿', ['ç»å•†', 'è°ˆåˆ¤'], 'çµæ´»'),
                'å«å…µ': ('å¿ è¯š', 'æ‘åº„çš„å®ˆå«ï¼Œå°½èŒå°½è´£', ['æˆ˜æ–—', 'è­¦æˆ’'], 'ä¸¥è‚ƒ')
            },
            'æ£®æ—': {
                'ç²¾çµ': ('ä¼˜é›…', 'æ£®æ—çš„ç²¾çµï¼Œä¸è‡ªç„¶èä¸ºä¸€ä½“', ['å°„ç®­', 'é­”æ³•', 'è‡ªç„¶ä¹‹åŠ›'], 'å¹³é™'),
                'å¾·é²ä¼Š': ('ç¥ç§˜', 'æ£®æ—çš„å®ˆæŠ¤è€…ï¼Œèƒ½å˜èº«ä¸ºåŠ¨ç‰©', ['å˜å½¢', 'è‡ªç„¶é­”æ³•', 'æ²»ç–—'], 'æ²‰æ€'),
                'çŒäºº': ('æ•é”', 'æ£®æ—çš„çŒäººï¼Œç†Ÿæ‚‰æ¯ä¸€å¯¸åœŸåœ°', ['ç‹©çŒ', 'è¿½è¸ª', 'é™·é˜±'], 'ä¸“æ³¨'),
                'æ¨µå¤«': ('å¼ºå£®', 'ä»¥ç æŸ´ä¸ºç”Ÿï¼ŒåŠ›å¤§æ— ç©·', ['ä¼æœ¨', 'ç”Ÿå­˜', 'æˆ˜æ–—'], 'ç›´ç‡'),
                'éšå£«': ('å­¤ç‹¬', 'éšå±…æ£®æ—çš„æ™ºè€…ï¼Œè¿œç¦»å°˜ä¸–', ['å†¥æƒ³', 'çŸ¥è¯†', 'è‡ªç„¶'], 'å¹³é™')
            },
            'æ²™æ¼ ': {
                'å•†é˜Ÿé¦–é¢†': ('æœæ–­', 'æ²™æ¼ å•†é˜Ÿçš„é¦–é¢†ï¼Œç»éªŒä¸°å¯Œ', ['é¢†å¯¼', 'å¯¼èˆª', 'äº¤æ˜“'], 'è‡ªä¿¡'),
                'å‘å¯¼': ('åšéŸ§', 'ç†Ÿæ‚‰æ²™æ¼ çš„å‘å¯¼ï¼Œèƒ½åœ¨æ²™æ¼ ä¸­æ‰¾åˆ°è·¯', ['å¯¼èˆª', 'ç”Ÿå­˜', 'ä¾¦æŸ¥'], 'è°¨æ…'),
                'ç»¿æ´²å®ˆå«': ('å¿ è¯š', 'ç»¿æ´²çš„å®ˆæŠ¤è€…ï¼Œä¿æŠ¤æ°´æº', ['æˆ˜æ–—', 'è­¦æˆ’', 'ç”Ÿå­˜'], 'ä¸¥è‚ƒ'),
                'æ²™æ¼ å•†äºº': ('ç²¾æ˜', 'åœ¨æ²™æ¼ ä¸­åšç”Ÿæ„çš„å•†äºº', ['ç»å•†', 'è°ˆåˆ¤', 'ç”Ÿå­˜'], 'åœ†æ»‘'),
                'æ¸¸ç‰§æ°‘': ('è‡ªç”±', 'æ²™æ¼ ä¸­çš„æ¸¸ç‰§æ°‘ï¼Œé€æ°´è‰è€Œå±…', ['æ”¾ç‰§', 'ç”Ÿå­˜', 'é©¬æœ¯'], 'å¼€æœ—')
            },
            'åœ°ç‰¢': {
                'å®ˆå«': ('ä¸¥è‚ƒ', 'åœ°ç‰¢çš„å®ˆå«ï¼Œæªå°½èŒå®ˆ', ['æˆ˜æ–—', 'è­¦æˆ’', 'ä¾¦æŸ¥'], 'è­¦æƒ•'),
                'ç‹±å’': ('å†·é…·', 'åœ°ç‰¢çš„ç‹±å’ï¼Œé“çŸ³å¿ƒè‚ ', ['æˆ˜æ–—', 'å®¡è®¯', 'è­¦æˆ’'], 'é˜´éƒ'),
                'æ³•å¸ˆ': ('ç–¯ç‹‚', 'åœ¨åœ°ç‰¢ä¸­ç ”ç©¶é»‘æš—é­”æ³•çš„æ³•å¸ˆ', ['é»‘æš—é­”æ³•', 'å¬å”¤', 'è¯…å’’'], 'ç–¯ç‹‚'),
                'ç›—è´¼': ('ç‹¡çŒ¾', 'èº²åœ¨åœ°ç‰¢ä¸­çš„ç›—è´¼', ['æ½œè¡Œ', 'å¼€é”', 'å·çªƒ'], 'è­¦æƒ•'),
                'éª·é«…å…µ': ('éº»æœ¨', 'è¢«é­”æ³•å¤æ´»çš„éª·é«…å…µ', ['æˆ˜æ–—', 'ä¸æ­»'], 'éº»æœ¨')
            },
            'åŸå¸‚': {
                'éª‘å£«': ('è£è€€', 'åŸå¸‚çš„éª‘å£«ï¼Œä¿æŠ¤å¸‚æ°‘', ['æˆ˜æ–—', 'éª‘é©¬', 'ç¤¼ä»ª'], 'è‡ªè±ª'),
                'è´µæ—': ('å‚²æ…¢', 'åŸå¸‚çš„è´µæ—ï¼Œèº«ä»½æ˜¾èµ«', ['å¤–äº¤', 'è‰ºæœ¯', 'ç¤¼ä»ª'], 'å‚²æ…¢'),
                'å•†äºº': ('ç²¾æ˜', 'åŸå¸‚çš„å¯Œå•†ï¼Œå®¶è´¢ä¸‡è´¯', ['ç»å•†', 'æŠ•èµ„', 'è°ˆåˆ¤'], 'è‡ªä¿¡'),
                'å­¦è€…': ('åšå­¦', 'åŸå¸‚å­¦é™¢çš„å­¦è€…ï¼ŒçŸ¥è¯†æ¸Šåš', ['çŸ¥è¯†', 'ç ”ç©¶', 'é­”æ³•'], 'ä¸“æ³¨'),
                'å«å…µ': ('å°½èŒ', 'åŸå¸‚çš„å«å…µï¼Œç»´æŒç§©åº', ['æˆ˜æ–—', 'è­¦æˆ’', 'æ‰§æ³•'], 'ä¸¥è‚ƒ')
            },
            'æµ·æ»©': {
                'æ¸”å¤«': ('æ‚ é—²', 'ä»¥æ•é±¼ä¸ºç”Ÿï¼Œå–œæ¬¢å¤§æµ·', ['é’“é±¼', 'æ¸¸æ³³', 'èˆªæµ·'], 'è½»æ¾'),
                'æ°´æ‰‹': ('å‹‡æ•¢', 'èˆªæµ·çš„æ°´æ‰‹ï¼Œè§è¿‡å¤§é£å¤§æµª', ['èˆªæµ·', 'æˆ˜æ–—', 'ä¿®ç†'], 'è±ªæ”¾'),
                'æµ·ç›—': ('ç‹‚é‡', 'æµ·ä¸Šçš„æµ·ç›—ï¼Œæ¨ªè¡Œæ— å¿Œ', ['æˆ˜æ–—', 'èˆªæµ·', 'æ å¤º'], 'ç‹‚é‡'),
                'ç¯å¡”å®ˆå«': ('å­¤ç‹¬', 'ç¯å¡”çš„å®ˆå«ï¼Œå®ˆæŠ¤èˆªæµ·è€…', ['å®ˆæœ›', 'ç»´ä¿®', 'å¯¼èˆª'], 'å¹³é™'),
                'å•†äºº': ('ç²¾æ˜', 'æµ·è¾¹çš„å•†äººï¼Œåšæµ·å¤–è´¸æ˜“', ['ç»å•†', 'èˆªæµ·', 'è°ˆåˆ¤'], 'åœ†æ»‘')
            }
        }
        
        # æ ¹æ®åœ°å›¾ç±»å‹å’ŒNPCç±»å‹è®¾ç½®å±æ€§
        if self.map_type in personality_types:
            if self.npc_type in personality_types[self.map_type]:
                self.personality, self.background, self.skills, self.mood = personality_types[self.map_type][self.npc_type]
            else:
                # é»˜è®¤å±æ€§
                self.personality = "å‹å¥½"
                self.background = f"{self.map_type}çš„å±…æ°‘"
                self.skills = ["ç”Ÿå­˜"]
                self.mood = "æ­£å¸¸"
        else:
            # é»˜è®¤å±æ€§
            self.personality = "å‹å¥½"
            self.background = "æ™®é€šæ‘æ°‘"
            self.skills = ["ç”Ÿå­˜"]
            self.mood = "æ­£å¸¸"
    
    def _initialize_daily_routine(self):
        """åˆå§‹åŒ–NPCçš„æ—¥å¸¸è¡Œä¸º"""
        routines = {
            'æ‘åº„': {
                'æ‘é•¿': ['æ—©æ™¨å·¡è§†æ‘åº„', 'å¤„ç†æ‘åŠ¡', 'ä¸­åˆä¼‘æ¯', 'ä¸‹åˆç»§ç»­å·¥ä½œ', 'æ™šä¸Šåœ¨å®¶'],
                'æ­¦å™¨å•†': ['æ—©æ™¨å¼€åº—', 'åˆ¶ä½œæ­¦å™¨', 'ä¸­åˆä¼‘æ¯', 'ä¸‹åˆè¥ä¸š', 'æ™šä¸Šå…³é—¨'],
                'è¯åº—è€æ¿': ['æ—©æ™¨é‡‡é›†è‰è¯', 'åˆ¶ä½œè¯å“', 'ä¸­åˆä¼‘æ¯', 'ä¸‹åˆè¥ä¸š', 'æ™šä¸Šç ”ç©¶è‰è¯'],
                'é˜²å…·å•†': ['æ—©æ™¨å¼€åº—', 'åˆ¶ä½œé˜²å…·', 'ä¸­åˆä¼‘æ¯', 'ä¸‹åˆè¥ä¸š', 'æ™šä¸Šå…³é—¨'],
                'é“åŒ ': ['æ—©æ™¨å¼€å§‹æ‰“é“', 'ä¸­åˆä¼‘æ¯', 'ä¸‹åˆç»§ç»­æ‰“é“', 'æ™šä¸Šæ•´ç†å·¥å…·'],
                'æ³•å¸ˆ': ['æ—©æ™¨å†¥æƒ³', 'ç ”ç©¶é­”æ³•', 'ä¸­åˆä¼‘æ¯', 'ä¸‹åˆç»§ç»­ç ”ç©¶', 'æ™šä¸Šå†¥æƒ³'],
                'ç‰§å¸ˆ': ['æ—©æ™¨ç¥ˆç¥·', 'ä¸»æŒä»ªå¼', 'ä¸­åˆä¼‘æ¯', 'ä¸‹åˆå¸®åŠ©æ‘æ°‘', 'æ™šä¸Šç¥ˆç¥·'],
                'å¨å¸ˆ': ['æ—©æ™¨å‡†å¤‡é£Ÿæ', 'çƒ¹é¥ª', 'ä¸­åˆè¥ä¸š', 'ä¸‹åˆç»§ç»­çƒ¹é¥ª', 'æ™šä¸Šå…³é—¨'],
                'æ¸”å¤«': ['æ—©æ™¨æ•é±¼', 'ä¸­åˆä¼‘æ¯', 'ä¸‹åˆç»§ç»­æ•é±¼', 'æ™šä¸Šæ•´ç†æ¸”ç½‘'],
                'çŒäºº': ['æ—©æ™¨ç‹©çŒ', 'ä¸­åˆä¼‘æ¯', 'ä¸‹åˆç»§ç»­ç‹©çŒ', 'æ™šä¸Šå¤„ç†çŒç‰©'],
                'åŒ»ç”Ÿ': ['æ—©æ™¨å‡ºè¯Š', 'ä¸­åˆä¼‘æ¯', 'ä¸‹åˆç»§ç»­å‡ºè¯Š', 'æ™šä¸Šç ”ç©¶åŒ»æœ¯'],
                'æ•™å¸ˆ': ['æ—©æ™¨ä¸Šè¯¾', 'ä¸­åˆä¼‘æ¯', 'ä¸‹åˆç»§ç»­ä¸Šè¯¾', 'æ™šä¸Šå¤‡è¯¾'],
                'å•†äºº': ['æ—©æ™¨è¿›è´§', 'ä¸­åˆè¥ä¸š', 'ä¸‹åˆç»§ç»­è¥ä¸š', 'æ™šä¸Šç®—è´¦'],
                'å«å…µ': ['æ—©æ™¨å·¡é€»', 'ä¸­åˆä¼‘æ¯', 'ä¸‹åˆç»§ç»­å·¡é€»', 'æ™šä¸Šå€¼ç­']
            },
            'æ£®æ—': {
                'ç²¾çµ': ['æ—©æ™¨å†¥æƒ³', 'ç»´æŠ¤æ£®æ—', 'ä¸­åˆä¼‘æ¯', 'ä¸‹åˆç»§ç»­ç»´æŠ¤', 'æ™šä¸Šå†¥æƒ³'],
                'å¾·é²ä¼Š': ['æ—©æ™¨ä¸è‡ªç„¶äº¤æµ', 'ç ”ç©¶é­”æ³•', 'ä¸­åˆä¼‘æ¯', 'ä¸‹åˆç»§ç»­ç ”ç©¶', 'æ™šä¸Šä¸è‡ªç„¶äº¤æµ'],
                'çŒäºº': ['æ—©æ™¨ç‹©çŒ', 'ä¸­åˆä¼‘æ¯', 'ä¸‹åˆç»§ç»­ç‹©çŒ', 'æ™šä¸Šå¤„ç†çŒç‰©'],
                'æ¨µå¤«': ['æ—©æ™¨ç æŸ´', 'ä¸­åˆä¼‘æ¯', 'ä¸‹åˆç»§ç»­ç æŸ´', 'æ™šä¸Šæ•´ç†æŸ´ç«'],
                'éšå£«': ['æ—©æ™¨å†¥æƒ³', 'ç ”ç©¶å­¦é—®', 'ä¸­åˆä¼‘æ¯', 'ä¸‹åˆç»§ç»­ç ”ç©¶', 'æ™šä¸Šå†¥æƒ³']
            },
            'æ²™æ¼ ': {
                'å•†é˜Ÿé¦–é¢†': ['æ—©æ™¨æ•´é˜Ÿ', 'å¸¦é¢†å•†é˜Ÿå‡ºå‘', 'ä¸­åˆä¼‘æ¯', 'ä¸‹åˆç»§ç»­å‰è¿›', 'æ™šä¸Šæ‰è¥'],
                'å‘å¯¼': ['æ—©æ™¨ç¡®å®šè·¯çº¿', 'å¸¦é¢†é˜Ÿä¼', 'ä¸­åˆä¼‘æ¯', 'ä¸‹åˆç»§ç»­å‰è¿›', 'æ™šä¸Šè­¦æˆ’'],
                'ç»¿æ´²å®ˆå«': ['æ—©æ™¨å·¡é€»', 'ä¸­åˆä¼‘æ¯', 'ä¸‹åˆç»§ç»­å·¡é€»', 'æ™šä¸Šå€¼ç­'],
                'æ²™æ¼ å•†äºº': ['æ—©æ™¨å‡†å¤‡è´§ç‰©', 'å¯»æ‰¾é¡¾å®¢', 'ä¸­åˆä¼‘æ¯', 'ä¸‹åˆç»§ç»­äº¤æ˜“', 'æ™šä¸Šæ•´ç†è´§ç‰©'],
                'æ¸¸ç‰§æ°‘': ['æ—©æ™¨æ”¾ç‰§', 'ä¸­åˆä¼‘æ¯', 'ä¸‹åˆç»§ç»­æ”¾ç‰§', 'æ™šä¸Šæ‰è¥']
            },
            'åœ°ç‰¢': {
                'å®ˆå«': ['æ—©æ™¨æ¢ç­', 'å·¡é€»åœ°ç‰¢', 'ä¸­åˆä¼‘æ¯', 'ä¸‹åˆç»§ç»­å·¡é€»', 'æ™šä¸Šå€¼ç­'],
                'ç‹±å’': ['æ—©æ™¨æ£€æŸ¥ç‰¢æˆ¿', 'çœ‹ç®¡å›šçŠ¯', 'ä¸­åˆä¼‘æ¯', 'ä¸‹åˆç»§ç»­çœ‹ç®¡', 'æ™šä¸Šå€¼ç­'],
                'æ³•å¸ˆ': ['æ—©æ™¨ç ”ç©¶é­”æ³•', 'è¿›è¡Œå®éªŒ', 'ä¸­åˆä¼‘æ¯', 'ä¸‹åˆç»§ç»­ç ”ç©¶', 'æ™šä¸Šè¿›è¡Œä»ªå¼'],
                'ç›—è´¼': ['æ—©æ™¨ä¼‘æ¯', 'ä¸­åˆæ´»åŠ¨', 'ä¸‹åˆå¯»æ‰¾æœºä¼š', 'æ™šä¸Šå·çªƒ'],
                'éª·é«…å…µ': ['å…¨å¤©ç«™å²—', 'æ‰§è¡Œå‘½ä»¤', 'æ²¡æœ‰ä¼‘æ¯']
            },
            'åŸå¸‚': {
                'éª‘å£«': ['æ—©æ™¨è®­ç»ƒ', 'æ‰§è¡Œä»»åŠ¡', 'ä¸­åˆä¼‘æ¯', 'ä¸‹åˆç»§ç»­æ‰§è¡Œä»»åŠ¡', 'æ™šä¸Šä¼‘æ¯'],
                'è´µæ—': ['æ—©æ™¨å‚åŠ ç¤¾äº¤æ´»åŠ¨', 'å¤„ç†äº‹åŠ¡', 'ä¸­åˆå‚åŠ å®´ä¼š', 'ä¸‹åˆç»§ç»­ç¤¾äº¤', 'æ™šä¸Šå‚åŠ æ™šå®´'],
                'å•†äºº': ['æ—©æ™¨å¤„ç†ä¸šåŠ¡', 'ä¸­åˆä¼‘æ¯', 'ä¸‹åˆç»§ç»­å¤„ç†ä¸šåŠ¡', 'æ™šä¸Šå‚åŠ ç¤¾äº¤æ´»åŠ¨'],
                'å­¦è€…': ['æ—©æ™¨ç ”ç©¶', 'ä¸­åˆä¼‘æ¯', 'ä¸‹åˆç»§ç»­ç ”ç©¶', 'æ™šä¸Šæ•´ç†èµ„æ–™'],
                'å«å…µ': ['æ—©æ™¨å·¡é€»', 'ä¸­åˆä¼‘æ¯', 'ä¸‹åˆç»§ç»­å·¡é€»', 'æ™šä¸Šå€¼ç­']
            },
            'æµ·æ»©': {
                'æ¸”å¤«': ['æ—©æ™¨å‡ºæµ·æ•é±¼', 'ä¸­åˆä¼‘æ¯', 'ä¸‹åˆç»§ç»­æ•é±¼', 'æ™šä¸Šæ•´ç†æ¸”ç½‘'],
                'æ°´æ‰‹': ['æ—©æ™¨ç»´ä¿®èˆ¹åª', 'ä¸­åˆä¼‘æ¯', 'ä¸‹åˆå‡ºæµ·', 'æ™šä¸Šå½’æ¥'],
                'æµ·ç›—': ['æ—©æ™¨è®¡åˆ’è¢­å‡»', 'ä¸­åˆä¼‘æ¯', 'ä¸‹åˆå¯»æ‰¾ç›®æ ‡', 'æ™šä¸Šè¢­å‡»'],
                'ç¯å¡”å®ˆå«': ['æ—©æ™¨æ£€æŸ¥ç¯å¡”', 'ä¸­åˆä¼‘æ¯', 'ä¸‹åˆç»§ç»­æ£€æŸ¥', 'æ™šä¸Šå€¼ç­'],
                'å•†äºº': ['æ—©æ™¨å‡†å¤‡è´§ç‰©', 'ä¸­åˆè¥ä¸š', 'ä¸‹åˆç»§ç»­è¥ä¸š', 'æ™šä¸Šæ•´ç†è´¦ç›®']
            }
        }
        
        # æ ¹æ®åœ°å›¾ç±»å‹å’ŒNPCç±»å‹è®¾ç½®æ—¥å¸¸è¡Œä¸º
        if self.map_type in routines:
            if self.npc_type in routines[self.map_type]:
                self.daily_routine = routines[self.map_type][self.npc_type]
            else:
                # é»˜è®¤æ—¥å¸¸è¡Œä¸º
                self.daily_routine = ['æ—©æ™¨æ´»åŠ¨', 'ä¸­åˆä¼‘æ¯', 'ä¸‹åˆæ´»åŠ¨', 'æ™šä¸Šä¼‘æ¯']
        else:
            # é»˜è®¤æ—¥å¸¸è¡Œä¸º
            self.daily_routine = ['æ—©æ™¨æ´»åŠ¨', 'ä¸­åˆä¼‘æ¯', 'ä¸‹åˆæ´»åŠ¨', 'æ™šä¸Šä¼‘æ¯']
    
    def _initialize_contextual_dialogue(self):
        """åˆå§‹åŒ–NPCçš„ä¸Šä¸‹æ–‡å¯¹è¯"""
        contextual_dialogues = {
            'æ‘åº„': {
                'æ‘é•¿': {
                    'greeting': 'æ¬¢è¿å›æ¥ï¼Œå†’é™©è€…ï¼æ‘åº„æœ€è¿‘ä¸€åˆ‡å®‰å¥½ã€‚',
                    'quest': 'æˆ‘ä»¬çš„æ‘åº„éœ€è¦ä½ çš„å¸®åŠ©ï¼Œæœ€è¿‘é™„è¿‘çš„æ€ªç‰©è¶Šæ¥è¶Šå¤šäº†ã€‚',
                    'farewell': 'ç¥ä½ å¥½è¿ï¼Œå‹‡æ•¢çš„å†’é™©è€…ï¼',
                    'happy': 'çœ‹åˆ°æ‘åº„ç¹è£ï¼Œæˆ‘çœŸæ˜¯å¤ªé«˜å…´äº†ï¼',
                    'sad': 'æœ€è¿‘æ‘åº„çš„æ”¶æˆä¸å¤ªå¥½ï¼ŒçœŸæ˜¯è®©äººæ‹…å¿ƒã€‚',
                    'angry': 'é‚£äº›æ€ªç‰©ç«Ÿæ•¢éªšæ‰°æˆ‘ä»¬çš„æ‘æ°‘ï¼Œå¿…é¡»ç»™ä»–ä»¬ç‚¹é¢œè‰²çœ‹çœ‹ï¼'
                },
                'æ­¦å™¨å•†': {
                    'greeting': 'å˜¿ï¼Œå…„å¼Ÿï¼æ¥çœ‹ç‚¹å¥½è´§å—ï¼Ÿ',
                    'quest': 'æˆ‘éœ€è¦ä¸€äº›é“çŸ¿çŸ³æ¥æ‰“é€ æ›´å¥½çš„æ­¦å™¨ï¼Œä½ èƒ½å¸®æˆ‘æ”¶é›†å—ï¼Ÿ',
                    'farewell': 'æœ‰ç©ºå†æ¥ï¼Œæˆ‘è¿™é‡Œæ°¸è¿œæœ‰æœ€å¥½çš„æ­¦å™¨ï¼',
                    'happy': 'æœ€è¿‘ç”Ÿæ„ä¸é”™ï¼Œå¤šäºäº†åƒä½ è¿™æ ·çš„å‹‡å£«ï¼',
                    'sad': 'æœ€è¿‘é“çŸ¿çŸ³çš„ä»·æ ¼æ¶¨äº†ï¼Œç”Ÿæ„ä¸å¤ªå¥½åšã€‚',
                    'angry': 'é‚£äº›å·æˆ‘æ­¦å™¨çš„å°è´¼ï¼Œåˆ«è®©æˆ‘æŠ“ä½ä»–ä»¬ï¼'
                },
                'è¯åº—è€æ¿': {
                    'greeting': 'ä½ å¥½ï¼Œéœ€è¦ç‚¹ä»€ä¹ˆè¯å—ï¼Ÿ',
                    'quest': 'æˆ‘éœ€è¦ä¸€äº›ç¨€æœ‰è‰è¯æ¥åˆ¶ä½œç‰¹æ•ˆè¯ï¼Œä½ èƒ½å¸®æˆ‘æ‰¾åˆ°å—ï¼Ÿ',
                    'farewell': 'ç¥ä½ å¥åº·ï¼Œå†’é™©è€…ï¼',
                    'happy': 'çœ‹åˆ°æˆ‘çš„è¯èƒ½å¸®åŠ©åˆ°ä½ ï¼Œæˆ‘å¾ˆå¼€å¿ƒã€‚',
                    'sad': 'æœ€è¿‘è‰è¯çš„äº§é‡ä¸‹é™äº†ï¼Œæˆ‘å¾ˆæ‹…å¿ƒã€‚',
                    'angry': 'é‚£äº›ç ´åè‰è¯çš„é‡å…½ï¼ŒçœŸæ˜¯å¤ªå¯æ¶äº†ï¼'
                }
            },
            'æ£®æ—': {
                'ç²¾çµ': {
                    'greeting': 'æ¬¢è¿æ¥åˆ°æ£®æ—ï¼Œäººç±»ã€‚',
                    'quest': 'æœ‰ä¸€äº›è´ªå©ªçš„äººç±»åœ¨ç ä¼æˆ‘ä»¬çš„æ ‘æœ¨ï¼Œä½ èƒ½é˜»æ­¢ä»–ä»¬å—ï¼Ÿ',
                    'farewell': 'æ„¿è‡ªç„¶ä¸ä½ åŒåœ¨ã€‚',
                    'happy': 'çœ‹åˆ°æ£®æ—ç”Ÿæœºå‹ƒå‹ƒï¼Œæˆ‘å¾ˆæ¬£æ…°ã€‚',
                    'sad': 'æ£®æ—çš„å¹³è¡¡è¢«æ‰“ç ´äº†ï¼Œæˆ‘å¾ˆæ‹…å¿ƒã€‚',
                    'angry': 'é‚£äº›ç ´åæ£®æ—çš„å®¶ä¼™ï¼Œå¿…é¡»å—åˆ°æƒ©ç½šï¼'
                },
                'å¾·é²ä¼Š': {
                    'greeting': 'ä½ å¥½ï¼Œæ—…è¡Œè€…ã€‚ä½ å¯¹è‡ªç„¶æœ‰ä»€ä¹ˆç–‘é—®å—ï¼Ÿ',
                    'quest': 'æ£®æ—ä¸­çš„æ°´æºè¢«æ±¡æŸ“äº†ï¼Œä½ èƒ½å¸®æˆ‘æ‰¾å‡ºåŸå› å—ï¼Ÿ',
                    'farewell': 'æ„¿è‡ªç„¶ä¹‹åŠ›ä¿æŠ¤ä½ ã€‚',
                    'happy': 'è‡ªç„¶çš„åŠ›é‡æ˜¯æ— ç©·çš„ã€‚',
                    'sad': 'è‡ªç„¶æ­£åœ¨é­å—ç ´åï¼Œæˆ‘å¿…é¡»åšç‚¹ä»€ä¹ˆã€‚',
                    'angry': 'é‚£äº›æ±¡æŸ“è‡ªç„¶çš„äººï¼Œå¿…å°†å—åˆ°æƒ©ç½šï¼'
                }
            },
            'æ²™æ¼ ': {
                'å•†é˜Ÿé¦–é¢†': {
                    'greeting': 'ä½ å¥½ï¼Œæ—…è¡Œè€…ï¼è¦åŠ å…¥æˆ‘ä»¬çš„å•†é˜Ÿå—ï¼Ÿ',
                    'quest': 'æˆ‘ä»¬çš„å•†é˜Ÿè¢«æ²™æ¼ å¼ºç›—è¢­å‡»äº†ï¼Œä½ èƒ½å¸®æˆ‘ä»¬æ‰¾å›è´§ç‰©å—ï¼Ÿ',
                    'farewell': 'ç¥ä½ æ—…é€”æ„‰å¿«ï¼Œå°å¿ƒæ²™æ¼ çš„å±é™©ï¼',
                    'happy': 'å•†é˜Ÿä¸€åˆ‡é¡ºåˆ©ï¼ŒçœŸæ˜¯å¤ªå¥½äº†ï¼',
                    'sad': 'æ²™æ¼ çš„ç¯å¢ƒè¶Šæ¥è¶Šæ¶åŠ£äº†ã€‚',
                    'angry': 'é‚£äº›æ²™æ¼ å¼ºç›—ï¼Œåˆ«è®©æˆ‘å†ç¢°åˆ°ä»–ä»¬ï¼'
                },
                'å‘å¯¼': {
                    'greeting': 'ä½ å¥½ï¼Œéœ€è¦æ²™æ¼ å‘å¯¼å—ï¼Ÿ',
                    'quest': 'æˆ‘çš„æŒ‡å—é’ˆåäº†ï¼Œä½ èƒ½å¸®æˆ‘æ‰¾åˆ°æ–°çš„å—ï¼Ÿ',
                    'farewell': 'å°å¿ƒæ²™æ¼ çš„æ²™æš´ï¼Œå®ƒä»¬å¾ˆå±é™©ï¼',
                    'happy': 'ä»Šå¤©çš„å¤©æ°”ä¸é”™ï¼Œé€‚åˆæ—…è¡Œã€‚',
                    'sad': 'æ²™æ¼ çš„æ°´æºè¶Šæ¥è¶Šå°‘äº†ã€‚',
                    'angry': 'é‚£äº›æµªè´¹æ°´èµ„æºçš„äººï¼ŒçœŸæ˜¯å¤ªå¯æ¶äº†ï¼'
                }
            },
            'åœ°ç‰¢': {
                'å®ˆå«': {
                    'greeting': 'ç«™ä½ï¼è¿™é‡Œæ˜¯ç¦åœ°ï¼Œæœªç»è®¸å¯ä¸å¾—å…¥å†…ã€‚',
                    'quest': 'åœ°ç‰¢é‡Œæœ‰å›šçŠ¯é€ƒè·‘äº†ï¼Œä½ èƒ½å¸®æˆ‘æŠŠä»–ä»¬æŠ“å›æ¥å—ï¼Ÿ',
                    'farewell': 'ç¦»å¼€è¿™é‡Œï¼Œä¸è¦å†æ¥äº†ã€‚',
                    'happy': 'ä»Šå¤©åœ°ç‰¢å¾ˆå®‰é™ï¼ŒçœŸæ˜¯éš¾å¾—ã€‚',
                    'sad': 'åœ°ç‰¢çš„æ¡ä»¶è¶Šæ¥è¶Šå·®äº†ã€‚',
                    'angry': 'é‚£äº›å›šçŠ¯ç«Ÿæ•¢åæŠ—ï¼ŒçœŸæ˜¯ä¸çŸ¥æ­»æ´»ï¼'
                },
                'æ³•å¸ˆ': {
                    'greeting': 'å“ˆå“ˆï¼Œåˆæœ‰æ–°çš„å®éªŒå“æ¥äº†ï¼',
                    'quest': 'æˆ‘éœ€è¦ä¸€äº›çµé­‚çŸ³æ¥å¢å¼ºæˆ‘çš„é­”æ³•ï¼Œä½ èƒ½å¸®æˆ‘æ‰¾åˆ°å—ï¼Ÿ',
                    'farewell': 'æ»šå§ï¼Œç­‰æˆ‘éœ€è¦ä½ çš„æ—¶å€™ä¼šå†æ‰¾ä½ ï¼',
                    'happy': 'æˆ‘çš„å®éªŒè¿›å±•é¡ºåˆ©ï¼ŒçœŸæ˜¯å¤ªå¥½äº†ï¼',
                    'sad': 'æˆ‘çš„å®éªŒå¤±è´¥äº†ï¼Œåˆè¦ä»å¤´å¼€å§‹ã€‚',
                    'angry': 'é‚£äº›ç ´åæˆ‘å®éªŒçš„äººï¼Œæˆ‘è¦è®©ä»–ä»¬ä»˜å‡ºä»£ä»·ï¼'
                }
            }
        }
        
        # æ ¹æ®åœ°å›¾ç±»å‹å’ŒNPCç±»å‹è®¾ç½®ä¸Šä¸‹æ–‡å¯¹è¯
        if self.map_type in contextual_dialogues:
            if self.npc_type in contextual_dialogues[self.map_type]:
                self.contextual_dialogue = contextual_dialogues[self.map_type][self.npc_type]
            else:
                # é»˜è®¤ä¸Šä¸‹æ–‡å¯¹è¯
                self.contextual_dialogue = {
                    'greeting': 'ä½ å¥½ï¼Œæ—…è¡Œè€…ã€‚',
                    'quest': 'æˆ‘éœ€è¦ä½ çš„å¸®åŠ©ã€‚',
                    'farewell': 'å†è§ï¼Œç¥ä½ å¥½è¿ï¼',
                    'happy': 'ä»Šå¤©çœŸæ˜¯ä¸ªå¥½æ—¥å­ï¼',
                    'sad': 'ä»Šå¤©æœ‰ç‚¹éš¾è¿‡ã€‚',
                    'angry': 'æˆ‘å¾ˆç”Ÿæ°”ï¼'
                }
        else:
            # é»˜è®¤ä¸Šä¸‹æ–‡å¯¹è¯
            self.contextual_dialogue = {
                'greeting': 'ä½ å¥½ï¼Œæ—…è¡Œè€…ã€‚',
                'quest': 'æˆ‘éœ€è¦ä½ çš„å¸®åŠ©ã€‚',
                'farewell': 'å†è§ï¼Œç¥ä½ å¥½è¿ï¼',
                'happy': 'ä»Šå¤©çœŸæ˜¯ä¸ªå¥½æ—¥å­ï¼',
                'sad': 'ä»Šå¤©æœ‰ç‚¹éš¾è¿‡ã€‚',
                'angry': 'æˆ‘å¾ˆç”Ÿæ°”ï¼'
            }
    
    def render(self, screen):
        """æ¸²æŸ“NPC"""
        # æ ¹æ®NPCç±»å‹å’Œä¸ªæ€§è®¾ç½®é¢œè‰²
        npc_colors = {
            # æ‘åº„NPC
            'æ‘é•¿': (255, 215, 0),  # é‡‘è‰²
            'æ­¦å™¨å•†': (255, 165, 0),  # æ©™è‰²
            'è¯åº—è€æ¿': (0, 255, 0),  # ç»¿è‰²
            'é˜²å…·å•†': (0, 0, 255),  # è“è‰²
            'é“åŒ ': (128, 128, 128),  # ç°è‰²
            'æ³•å¸ˆ': (128, 0, 128),  # ç´«è‰²
            'ç‰§å¸ˆ': (255, 255, 255),  # ç™½è‰²
            'å¨å¸ˆ': (255, 105, 180),  # ç²‰è‰²
            'æ¸”å¤«': (0, 191, 255),  # æ·±å¤©è“è‰²
            'çŒäºº': (139, 69, 19),  # æ£•è‰²
            'åŒ»ç”Ÿ': (0, 255, 255),  # é’è‰²
            'æ•™å¸ˆ': (218, 112, 214),  # å…°èŠ±è‰²
            'å•†äºº': (255, 215, 0),  # é‡‘è‰²
            'å«å…µ': (169, 169, 169),  # æ·±ç°è‰²
            # æ£®æ—NPC
            'ç²¾çµ': (0, 255, 127),  #  springgreen
            'å¾·é²ä¼Š': (34, 139, 34),  #  forestgreen
            'çŒäºº': (139, 69, 19),  # æ£•è‰²
            'æ¨µå¤«': (160, 82, 45),  #  sienna
            'éšå£«': (107, 142, 35),  #  olivegreen
            # æ²™æ¼ NPC
            'å•†é˜Ÿé¦–é¢†': (218, 165, 32),  #  goldenrod
            'å‘å¯¼': (244, 164, 96),  #  sandybrown
            'ç»¿æ´²å®ˆå«': (32, 178, 170),  #  lightseagreen
            'æ²™æ¼ å•†äºº': (210, 105, 30),  #  chocolate
            'æ¸¸ç‰§æ°‘': (222, 184, 135),  #  burlywood
            # åœ°ç‰¢NPC
            'å®ˆå«': (105, 105, 105),  #  dimgray
            'ç‹±å’': (169, 169, 169),  #  darkgray
            'æ³•å¸ˆ': (128, 0, 128),  # ç´«è‰²
            'ç›—è´¼': (0, 0, 128),  #  darkblue
            'éª·é«…å…µ': (220, 220, 220),  #  gainsboro
            # åŸå¸‚NPC
            'éª‘å£«': (0, 0, 205),  #  mediumblue
            'è´µæ—': (255, 215, 0),  # é‡‘è‰²
            'å•†äºº': (218, 165, 32),  #  goldenrod
            'å­¦è€…': (70, 130, 180),  #  steelblue
            'å«å…µ': (105, 105, 105),  #  dimgray
            # æµ·æ»©NPC
            'æ¸”å¤«': (0, 191, 255),  # æ·±å¤©è“è‰²
            'æ°´æ‰‹': (30, 144, 255),  #  dodgerblue
            'æµ·ç›—': (139, 0, 0),  #  darkred
            'ç¯å¡”å®ˆå«': (135, 206, 250),  #  lightskyblue
            'å•†äºº': (218, 165, 32),  #  goldenrod
            # é»˜è®¤
            'æ™®é€š': (255, 255, 0)  # é»„è‰²
        }
        
        # åŸºç¡€é¢œè‰²
        base_color = npc_colors.get(self.npc_type, (255, 255, 0))
        
        # æ ¹æ®å¿ƒæƒ…è°ƒæ•´é¢œè‰²äº®åº¦
        mood_brightness = {
            'æ­£å¸¸': 1.0,
            'ç§¯æ': 1.2,
            'æ¸©å’Œ': 0.9,
            'è°¨æ…': 0.8,
            'ç›´ç‡': 1.1,
            'å¹³é™': 0.9,
            'ç¥åœ£': 1.3,
            'æ¬¢å¿«': 1.2,
            'è½»æ¾': 1.0,
            'ä¸“æ³¨': 0.8,
            'å†·é™': 0.9,
            'çµæ´»': 1.0,
            'ä¸¥è‚ƒ': 0.8,
            'æ²‰æ€': 0.7,
            'è­¦æƒ•': 1.1,
            'é˜´éƒ': 0.6,
            'ç–¯ç‹‚': 1.3,
            'è‡ªè±ª': 1.2,
            'å‚²æ…¢': 1.1,
            'è‡ªä¿¡': 1.1,
            'è±ªæ”¾': 1.2,
            'ç‹‚é‡': 1.3,
            'éº»æœ¨': 0.5
        }
        
        brightness = mood_brightness.get(self.mood, 1.0)
        # è°ƒæ•´é¢œè‰²äº®åº¦
        color = tuple(min(255, int(c * brightness)) for c in base_color)
        
        # æ ¹æ®NPCç±»å‹ç»˜åˆ¶ä¸åŒçš„å½¢çŠ¶
        if self.npc_type in ['ç²¾çµ', 'å¾·é²ä¼Š']:
            # ç²¾çµå’Œå¾·é²ä¼Šä½¿ç”¨åœ†å½¢
            pygame.draw.circle(screen, color, (self.x + 16, self.y + 16), 16)
        elif self.npc_type in ['æ³•å¸ˆ', 'ç‰§å¸ˆ']:
            # æ³•å¸ˆå’Œç‰§å¸ˆä½¿ç”¨å…­è¾¹å½¢
            points = []
            for i in range(6):
                angle = (i * 60) * 3.14159 / 180
                x = self.x + 16 + 16 * math.cos(angle)
                y = self.y + 16 + 16 * math.sin(angle)
                points.append((x, y))
            pygame.draw.polygon(screen, color, points)
        elif self.npc_type in ['æˆ˜å£«', 'éª‘å£«', 'å«å…µ']:
            # æˆ˜å£«ç±»ä½¿ç”¨çŸ©å½¢ä½†æœ‰æ£±è§’
            pygame.draw.rect(screen, color, (self.x + 4, self.y + 4, 24, 24))
        else:
            # å…¶ä»–NPCä½¿ç”¨æ™®é€šçŸ©å½¢
            pygame.draw.rect(screen, color, (self.x, self.y, 32, 32))
        
        # æ·»åŠ è£…é¥°å…ƒç´ 
        self._draw_decorations(screen, color)
        
        # ç»˜åˆ¶NPCåå­—
        try:
            font = pygame.font.SysFont('hiraginosansgb', 12)
        except:
            try:
                font = pygame.font.SysFont('songti', 12)
            except:
                try:
                    font = pygame.font.SysFont('arialunicode', 12)
                except:
                    font = pygame.font.Font(None, 12)
        
        # æ ¹æ®å¿ƒæƒ…è°ƒæ•´æ–‡å­—é¢œè‰²
        text_color = color
        if brightness > 1.2:
            text_color = (0, 0, 0)  # æ·±è‰²èƒŒæ™¯ç”¨é»‘è‰²æ–‡å­—
        
        text = font.render(self.name, True, text_color)
        screen.blit(text, (self.x + 8, self.y - 15))
        
        # ç»˜åˆ¶NPCç±»å‹
        type_text = font.render(self.npc_type, True, (200, 200, 200))
        screen.blit(type_text, (self.x + 8, self.y + 35))
        
        # ç»˜åˆ¶NPCä¸ªæ€§
        personality_text = font.render(self.personality, True, (150, 150, 150))
        screen.blit(personality_text, (self.x + 8, self.y + 50))
        
        # ç»˜åˆ¶å¿ƒæƒ…æŒ‡ç¤ºå™¨
        self._draw_mood_indicator(screen)
    
    def _draw_decorations(self, screen, color):
        """ç»˜åˆ¶NPCè£…é¥°å…ƒç´ """
        # æ ¹æ®NPCç±»å‹æ·»åŠ è£…é¥°
        if self.npc_type == 'æ³•å¸ˆ':
            # æ³•å¸ˆæ·»åŠ é­”æ³•å…‰ç¯
            pygame.draw.circle(screen, (255, 255, 255), (self.x + 16, self.y + 16), 20, 2)
        elif self.npc_type == 'ç‰§å¸ˆ':
            # ç‰§å¸ˆæ·»åŠ å…‰ç¯
            pygame.draw.circle(screen, (255, 215, 0), (self.x + 16, self.y + 16), 20, 2)
        elif self.npc_type == 'ç²¾çµ':
            # ç²¾çµæ·»åŠ ç¿…è†€
            pygame.draw.line(screen, color, (self.x, self.y + 16), (self.x - 8, self.y + 8), 2)
            pygame.draw.line(screen, color, (self.x, self.y + 16), (self.x - 8, self.y + 24), 2)
            pygame.draw.line(screen, color, (self.x + 32, self.y + 16), (self.x + 40, self.y + 8), 2)
            pygame.draw.line(screen, color, (self.x + 32, self.y + 16), (self.x + 40, self.y + 24), 2)
        elif self.npc_type == 'æˆ˜å£«' or self.npc_type == 'éª‘å£«':
            # æˆ˜å£«æ·»åŠ æ­¦å™¨å›¾æ ‡
            pygame.draw.line(screen, (139, 69, 19), (self.x + 28, self.y + 8), (self.x + 36, self.y + 16), 2)
            pygame.draw.line(screen, (139, 69, 19), (self.x + 36, self.y + 16), (self.x + 28, self.y + 24), 2)
        elif self.npc_type == 'ç›—è´¼':
            # ç›—è´¼æ·»åŠ é¢å…·
            pygame.draw.rect(screen, (0, 0, 0), (self.x + 8, self.y + 8, 16, 4))
        
        # æ ¹æ®ä¸ªæ€§æ·»åŠ è£…é¥°
        if self.personality == 'ç¥ç§˜':
            # ç¥ç§˜ä¸ªæ€§æ·»åŠ é—®å·
            font = pygame.font.Font(None, 20)
            text = font.render('?', True, (255, 255, 255))
            screen.blit(text, (self.x + 12, self.y + 12))
        elif self.personality == 'ç–¯ç‹‚':
            # ç–¯ç‹‚ä¸ªæ€§æ·»åŠ æ„Ÿå¹å·
            font = pygame.font.Font(None, 20)
            text = font.render('!', True, (255, 0, 0))
            screen.blit(text, (self.x + 12, self.y + 12))
    
    def _draw_mood_indicator(self, screen):
        """ç»˜åˆ¶å¿ƒæƒ…æŒ‡ç¤ºå™¨"""
        # æ ¹æ®å¿ƒæƒ…ç»˜åˆ¶ä¸åŒçš„æŒ‡ç¤ºå™¨
        mood_indicators = {
            'ç§¯æ': 'ğŸ˜Š',
            'æ¸©å’Œ': 'ğŸ˜Œ',
            'è°¨æ…': 'ğŸ˜Ÿ',
            'ç›´ç‡': 'ğŸ˜€',
            'å¹³é™': 'ğŸ˜',
            'ç¥åœ£': 'ğŸ˜‡',
            'æ¬¢å¿«': 'ğŸ˜„',
            'è½»æ¾': 'ğŸ˜',
            'ä¸“æ³¨': 'ğŸ¤”',
            'å†·é™': 'ğŸ˜',
            'çµæ´»': 'ğŸ¤¨',
            'ä¸¥è‚ƒ': 'ğŸ˜ ',
            'æ²‰æ€': 'ğŸ§',
            'è­¦æƒ•': 'ğŸ˜¨',
            'é˜´éƒ': 'ğŸ˜”',
            'ç–¯ç‹‚': 'ğŸ˜ˆ',
            'è‡ªè±ª': 'ğŸ˜',
            'å‚²æ…¢': 'ğŸ˜’',
            'è‡ªä¿¡': 'ğŸ˜',
            'è±ªæ”¾': 'ğŸ¤ ',
            'ç‹‚é‡': 'ğŸ˜œ',
            'éº»æœ¨': 'ğŸ˜¶'
        }
        
        indicator = mood_indicators.get(self.mood, 'ğŸ˜')
        # ç»˜åˆ¶å¿ƒæƒ…æŒ‡ç¤ºå™¨
        font = pygame.font.Font(None, 16)
        text = font.render(indicator, True, (255, 255, 255))
        screen.blit(text, (self.x + 20, self.y - 15))
    
    def get_dialogue(self):
        """è·å–å¯¹è¯"""
        return self.dialogue
    
    def get_shop_items(self):
        """è·å–å•†åº—ç‰©å“"""
        if self.has_shop:
            return self.shop_items
        return []
    
    def is_near_player(self, player_x, player_y):
        """æ£€æŸ¥æ˜¯å¦é è¿‘ç©å®¶"""
        dx = player_x - self.x
        dy = player_y - self.y
        distance = (dx**2 + dy**2)**0.5
        return distance < 50
    
    def interact(self, player):
        """ä¸ç©å®¶äº¤äº’"""
        # è®°å½•äº¤äº’å†å²
        interaction = f"ä¸{player.èŒä¸š}äº¤äº’ï¼Œç­‰çº§{player.level}"
        self.dialogue_history.append(interaction)
        
        # è®°å½•äº’åŠ¨è®°å¿†
        self.memories.append({
            'player_class': player.èŒä¸š,
            'player_level': player.level,
            'player_name': getattr(player, 'name', 'å†’é™©è€…'),
            'interaction_type': 'å¯¹è¯',
            'timestamp': len(self.memories)
        })
        
        # æ›´æ–°ä¸ç©å®¶çš„å…³ç³»
        player_id = f"{player.èŒä¸š}_{getattr(player, 'name', 'å†’é™©è€…')}"
        if player_id not in self.relationships:
            self.relationships[player_id] = 0
        self.relationships[player_id] += 1
        
        # æ ¹æ®ç©å®¶èŒä¸šã€ç­‰çº§ã€ä¸NPCçš„å…³ç³»ã€NPCå¿ƒæƒ…ç”Ÿæˆå¯¹è¯
        dialogue = self._generate_contextual_dialogue(player)
        
        # éšæœºæ”¹å˜NPCå¿ƒæƒ…
        self._update_mood()
        
        return dialogue
    
    def _generate_contextual_dialogue(self, player):
        """ç”ŸæˆåŸºäºä¸Šä¸‹æ–‡çš„å¯¹è¯"""
        # è·å–ä¸ç©å®¶çš„å…³ç³»å€¼
        player_id = f"{player.èŒä¸š}_{getattr(player, 'name', 'å†’é™©è€…')}"
        relationship = self.relationships.get(player_id, 0)
        
        # åŸºäºç©å®¶èŒä¸šçš„å¯¹è¯
        if player.èŒä¸š == 'æ³•å¸ˆ' and self.npc_type == 'æ³•å¸ˆ':
            if relationship > 5:
                return f"äº²çˆ±çš„åŒè¡Œï¼{self.name}å¾ˆé«˜å…´å†æ¬¡è§åˆ°ä½ ã€‚æœ€è¿‘ç ”ç©¶äº†ä»€ä¹ˆæ–°é­”æ³•ï¼Ÿ"
            elif relationship > 2:
                return f"å“¦ï¼Œ{player.èŒä¸š}ï¼{self.name}å¯¹ä½ çš„é­”æ³•é€ è¯£å°è±¡æ·±åˆ»ã€‚"
            else:
                return f"å“¦ï¼Œä¸€ä½åŒè¡Œï¼{self.name}å¯¹ä½ çš„é­”æ³•å¤©èµ‹è¡¨ç¤ºèµèµã€‚"
        elif player.èŒä¸š == 'æˆ˜å£«' and self.npc_type == 'æ­¦å™¨å•†':
            if relationship > 5:
                return f"æˆ‘çš„å¥½å…„å¼Ÿï¼{self.name}ä¸ºä½ å‡†å¤‡äº†æœ€å¥½çš„æ­¦å™¨ï¼Œæ‰“å…«æŠ˜ï¼"
            elif relationship > 2:
                return f"å“ˆå“ˆï¼Œæˆ˜å£«ï¼{self.name}å¯¹ä½ çš„æˆ˜æ–—ç²¾ç¥è¡¨ç¤ºé’¦ä½©ï¼Œæ„¿æ„ç»™ä½ æ‰“ä¸ªæŠ˜æ‰£ã€‚"
            else:
                return f"æˆ˜å£«æœ‹å‹ï¼Œæ¥çœ‹çœ‹æˆ‘è¿™é‡Œçš„å¥½æ­¦å™¨ï¼"
        elif player.èŒä¸š == 'é“å£«' and self.npc_type == 'è¯åº—è€æ¿':
            if relationship > 5:
                return f"é“å£«å¤§å¸ˆï¼{self.name}ä¸ºä½ å‡†å¤‡äº†çè´µçš„è‰è¯ï¼Œæˆ‘ä»¬æ¥å¥½å¥½äº¤æµåŒ»æœ¯ã€‚"
            elif relationship > 2:
                return f"é“å£«å…ˆç”Ÿï¼Œ{self.name}å¯¹ä½ çš„åŒ»æœ¯å¾ˆæ„Ÿå…´è¶£ï¼Œæ„¿æ„ä¸ä½ äº¤æµå¿ƒå¾—ã€‚"
            else:
                return f"é“å£«æœ‹å‹ï¼Œéœ€è¦ä»€ä¹ˆè‰è¯å—ï¼Ÿ"
        
        # åŸºäºç©å®¶ç­‰çº§çš„å¯¹è¯
        if player.level < 10:
            level_dialogue = "å¹´è½»çš„å†’é™©è€…ï¼Œ"
        elif player.level < 20:
            level_dialogue = "å‹‡æ•¢çš„å†’é™©è€…ï¼Œ"
        else:
            level_dialogue = "å¼ºå¤§çš„å†’é™©è€…ï¼Œ"
        
        # åŸºäºNPCå¿ƒæƒ…çš„å¯¹è¯
        mood_dialogue = self._get_mood_dialogue()
        
        # åŸºäºäº¤äº’æ¬¡æ•°çš„å¯¹è¯
        if len(self.dialogue_history) == 1:
            # ç¬¬ä¸€æ¬¡äº¤äº’
            if 'greeting' in self.contextual_dialogue:
                return self.contextual_dialogue['greeting']
            else:
                return f"{level_dialogue}æ¬¢è¿æ¥åˆ°{self.map_type}ï¼æˆ‘æ˜¯{self.name}ï¼Œ{self.background}ã€‚"
        elif len(self.dialogue_history) < 5:
            # å¤šæ¬¡äº¤äº’
            if 'quest' in self.contextual_dialogue and player.level < 15:
                return self.contextual_dialogue['quest']
            else:
                return f"{level_dialogue}{mood_dialogue}æˆ‘æ˜¯{self.name}ï¼Œ{self.background}ã€‚"
        else:
            # ç†Ÿæ‚‰çš„äº¤äº’
            if 'farewell' in self.contextual_dialogue:
                return f"{mood_dialogue}å¾ˆé«˜å…´å†æ¬¡è§åˆ°ä½ ï¼Œ{player.èŒä¸š}ã€‚"
            else:
                return f"{level_dialogue}{mood_dialogue}æœ€è¿‘è¿‡å¾—æ€ä¹ˆæ ·ï¼Ÿ"
    
    def _get_mood_dialogue(self):
        """æ ¹æ®å¿ƒæƒ…ç”Ÿæˆå¯¹è¯å‰ç¼€"""
        mood_prefixes = {
            'æ­£å¸¸': '',
            'ç§¯æ': 'ä»Šå¤©å¿ƒæƒ…çœŸå¥½ï¼',
            'æ¸©å’Œ': 'æ…¢æ…¢æ¥ï¼Œ',
            'è°¨æ…': 'å°å¿ƒç‚¹ï¼Œ',
            'ç›´ç‡': 'è¯´å®è¯ï¼Œ',
            'å¹³é™': 'é™é™åœ°ï¼Œ',
            'ç¥åœ£': 'æ„¿ç¥ä¿ä½‘ä½ ï¼Œ',
            'æ¬¢å¿«': 'å“ˆå“ˆï¼',
            'è½»æ¾': 'æ”¾æ¾ç‚¹ï¼Œ',
            'ä¸“æ³¨': 'è®¤çœŸåœ°è¯´ï¼Œ',
            'å†·é™': 'å†·é™åœ°ï¼Œ',
            'çµæ´»': 'çµæ´»ç‚¹ï¼Œ',
            'ä¸¥è‚ƒ': 'ä¸¥è‚ƒåœ°è¯´ï¼Œ',
            'æ²‰æ€': 'æ€è€ƒç€ï¼Œ',
            'è­¦æƒ•': 'å°å¿ƒï¼',
            'é˜´éƒ': 'å”‰...',
            'ç–¯ç‹‚': 'å“ˆå“ˆå“ˆå“ˆï¼',
            'è‡ªè±ª': 'éª„å‚²åœ°ï¼Œ',
            'å‚²æ…¢': 'å“¼ï¼Œ',
            'è‡ªä¿¡': 'è‡ªä¿¡åœ°ï¼Œ',
            'è±ªæ”¾': 'ç—›å¿«ï¼',
            'ç‹‚é‡': 'æ¡€æ¡€æ¡€ï¼',
            'éº»æœ¨': ''
        }
        return mood_prefixes.get(self.mood, '')
    
    def _update_mood(self):
        """éšæœºæ›´æ–°NPCå¿ƒæƒ…"""
        # åŸºäºæ€§æ ¼çš„å¿ƒæƒ…å˜åŒ–
        mood_changes = {
            'æ…ˆç¥¥': ['æ­£å¸¸', 'ç§¯æ', 'æ¸©å’Œ'],
            'è±ªçˆ½': ['ç§¯æ', 'ç›´ç‡', 'æ¬¢å¿«'],
            'ç»†å¿ƒ': ['æ¸©å’Œ', 'è°¨æ…', 'å¹³é™'],
            'ç²¾æ˜': ['è°¨æ…', 'çµæ´»', 'è‡ªä¿¡'],
            'ç²—çŠ·': ['ç›´ç‡', 'è±ªæ”¾', 'ç§¯æ'],
            'ç¥ç§˜': ['å¹³é™', 'æ²‰æ€', 'è°¨æ…'],
            'è™”è¯š': ['ç¥åœ£', 'å¹³é™', 'æ¸©å’Œ'],
            'çƒ­æƒ…': ['æ¬¢å¿«', 'ç§¯æ', 'è½»æ¾'],
            'æ‚ é—²': ['è½»æ¾', 'å¹³é™', 'æ¸©å’Œ'],
            'æ•é”': ['ä¸“æ³¨', 'è­¦æƒ•', 'å†·é™'],
            'ä¸“ä¸š': ['å†·é™', 'ä¸“æ³¨', 'ä¸¥è‚ƒ'],
            'åšå­¦': ['ä¸“æ³¨', 'æ²‰æ€', 'å¹³é™'],
            'åœ†æ»‘': ['çµæ´»', 'è‡ªä¿¡', 'è°¨æ…'],
            'å¿ è¯š': ['ä¸¥è‚ƒ', 'è­¦æƒ•', 'æ­£å¸¸'],
            'ä¼˜é›…': ['å¹³é™', 'æ¸©å’Œ', 'æ­£å¸¸'],
            'é‡æ€§': ['è±ªæ”¾', 'ç‹‚é‡', 'ä¸“æ³¨'],
            'åšéŸ§': ['ä¸¥è‚ƒ', 'å†·é™', 'æ­£å¸¸'],
            'å­¤ç‹¬': ['æ²‰æ€', 'å¹³é™', 'é˜´éƒ'],
            'æœæ–­': ['ç›´ç‡', 'è‡ªä¿¡', 'ä¸¥è‚ƒ'],
            'ç‹¡çŒ¾': ['è­¦æƒ•', 'çµæ´»', 'è°¨æ…'],
            'éº»æœ¨': ['éº»æœ¨'],
            'è£è€€': ['è‡ªè±ª', 'ä¸¥è‚ƒ', 'æ­£å¸¸'],
            'å‚²æ…¢': ['å‚²æ…¢', 'è‡ªä¿¡', 'ä¸¥è‚ƒ'],
            'å‹‡æ•¢': ['è±ªæ”¾', 'ç§¯æ', 'ç›´ç‡']
        }
        
        possible_moods = mood_changes.get(self.personality, ['æ­£å¸¸'])
        if possible_moods:
            self.mood = possible_moods[0] if len(possible_moods) == 1 else possible_moods[len(self.dialogue_history) % len(possible_moods)]
    
    def get_personal_info(self):
        """è·å–NPCä¸ªäººä¿¡æ¯"""
        return {
            'name': self.name,
            'personality': self.personality,
            'background': self.background,
            'skills': self.skills,
            'map_type': self.map_type,
            'npc_type': self.npc_type
        }
    
    def give_quest(self, player):
        """ç»™äºˆä»»åŠ¡"""
        # æ ¹æ®åœ°å›¾ç±»å‹ã€NPCç±»å‹ã€ç©å®¶èŒä¸šå’Œç­‰çº§ç”Ÿæˆä»»åŠ¡
        player_level = getattr(player, 'level', 1)
        player_class = getattr(player, 'èŒä¸š', 'å†’é™©è€…')
        
        # ä»»åŠ¡æ•°æ®åº“
        quests = {
            'æ‘åº„': {
                'æ‘é•¿': [
                    {
                        'title': 'æ¶ˆç­é™„è¿‘çš„æ€ªç‰©',
                        'description': 'æ‘åº„é™„è¿‘çš„æ€ªç‰©è¶Šæ¥è¶Šå¤šï¼Œå¨èƒåˆ°äº†æ‘æ°‘çš„å®‰å…¨ã€‚è¯·æ¶ˆç­10åªæ€ªç‰©ã€‚',
                        'reward': {'exp': 100, 'gold': 500, 'items': ['é“å‰‘']},
                        'level_requirement': 1,
                        'type': 'combat'
                    },
                    {
                        'title': 'ä¿æŠ¤æ‘åº„',
                        'description': 'æ‘åº„å³å°†é­å—æ€ªç‰©è¢­å‡»ï¼Œè¯·åšå¥½å‡†å¤‡ä¿æŠ¤æ‘æ°‘ã€‚',
                        'reward': {'exp': 200, 'gold': 1000, 'items': ['é“ç”²', 'é‡‘ç–®è¯']},
                        'level_requirement': 10,
                        'type': 'defense'
                    }
                ],
                'æ­¦å™¨å•†': [
                    {
                        'title': 'æ”¶é›†é“çŸ¿çŸ³',
                        'description': 'æˆ‘éœ€è¦ä¸€äº›é“çŸ¿çŸ³æ¥æ‰“é€ æ­¦å™¨ã€‚è¯·æ”¶é›†10å—é“çŸ¿çŸ³ã€‚',
                        'reward': {'exp': 80, 'gold': 300, 'items': ['é“å‰‘']},
                        'level_requirement': 3,
                        'type': 'collection'
                    },
                    {
                        'title': 'å¯»æ‰¾ç¨€æœ‰é‡‘å±',
                        'description': 'æˆ‘éœ€è¦ä¸€äº›ç¨€æœ‰é‡‘å±æ¥æ‰“é€ é«˜çº§æ­¦å™¨ã€‚è¯·æ”¶é›†5å—ç§˜é“¶ã€‚',
                        'reward': {'exp': 150, 'gold': 800, 'items': ['ç§˜é“¶å‰‘']},
                        'level_requirement': 15,
                        'type': 'collection'
                    }
                ],
                'è¯åº—è€æ¿': [
                    {
                        'title': 'æ”¶é›†è‰è¯',
                        'description': 'æˆ‘éœ€è¦ä¸€äº›è‰è¯æ¥åˆ¶ä½œè¯æ°´ã€‚è¯·æ”¶é›†15æ ªè‰è¯ã€‚',
                        'reward': {'exp': 70, 'gold': 250, 'items': ['é‡‘ç–®è¯', 'é­”æ³•è¯']},
                        'level_requirement': 2,
                        'type': 'collection'
                    },
                    {
                        'title': 'å¯»æ‰¾ç¨€æœ‰è‰è¯',
                        'description': 'æˆ‘éœ€è¦ä¸€äº›ç¨€æœ‰è‰è¯æ¥åˆ¶ä½œé«˜çº§è¯æ°´ã€‚è¯·æ”¶é›†8æ ªåƒå¹´çµèŠã€‚',
                        'reward': {'exp': 180, 'gold': 900, 'items': ['è¶…çº§é‡‘ç–®è¯', 'è¶…çº§é­”æ³•è¯']},
                        'level_requirement': 12,
                        'type': 'collection'
                    }
                ],
                'ç‰§å¸ˆ': [
                    {
                        'title': 'å‡€åŒ–é‚ªæ¶',
                        'description': 'æ‘åº„é™„è¿‘æœ‰é‚ªæ¶çš„æ°”æ¯ï¼Œè¯·å‡€åŒ–5ä¸ªé‚ªæ¶çš„ç¥­å›ã€‚',
                        'reward': {'exp': 120, 'gold': 400, 'items': ['ç¥ç¦è¯æ°´']},
                        'level_requirement': 5,
                        'type': 'purification'
                    }
                ]
            },
            'æ£®æ—': {
                'ç²¾çµ': [
                    {
                        'title': 'ä¿æŠ¤æ£®æ—',
                        'description': 'æœ‰è´ªå©ªçš„äººç±»åœ¨ç ä¼æ£®æ—ï¼Œè¯·é˜»æ­¢ä»–ä»¬ã€‚',
                        'reward': {'exp': 150, 'gold': 600, 'items': ['ç²¾çµä¹‹å¼“']},
                        'level_requirement': 8,
                        'type': 'protection'
                    },
                    {
                        'title': 'å¯»æ‰¾æ£®æ—ä¹‹å¿ƒ',
                        'description': 'æ£®æ—ä¹‹å¿ƒè¢«ç›—ï¼Œè¯·æ‰¾å›å®ƒã€‚',
                        'reward': {'exp': 250, 'gold': 1200, 'items': ['è‡ªç„¶ä¹‹æˆ’']},
                        'level_requirement': 18,
                        'type': 'recovery'
                    }
                ],
                'å¾·é²ä¼Š': [
                    {
                        'title': 'å‡€åŒ–æ°´æº',
                        'description': 'æ£®æ—çš„æ°´æºè¢«æ±¡æŸ“äº†ï¼Œè¯·æ‰¾å‡ºæ±¡æŸ“æºå¹¶å‡€åŒ–å®ƒã€‚',
                        'reward': {'exp': 130, 'gold': 500, 'items': ['è‡ªç„¶è¯æ°´']},
                        'level_requirement': 6,
                        'type': 'purification'
                    }
                ],
                'çŒäºº': [
                    {
                        'title': 'çŒå–é‡å…½',
                        'description': 'æ£®æ—ä¸­çš„é‡å…½æ•°é‡è¿‡å¤šï¼Œè¯·çŒå–15åªç‹¼ã€‚',
                        'reward': {'exp': 110, 'gold': 350, 'items': ['çŒäººä¹‹å¼“']},
                        'level_requirement': 4,
                        'type': 'hunting'
                    }
                ]
            },
            'æ²™æ¼ ': {
                'å•†é˜Ÿé¦–é¢†': [
                    {
                        'title': 'ä¿æŠ¤å•†é˜Ÿ',
                        'description': 'å•†é˜Ÿå°†ç©¿è¶Šæ²™æ¼ ï¼Œè¯·ä¿æŠ¤å®ƒå…å—å¼ºç›—è¢­å‡»ã€‚',
                        'reward': {'exp': 180, 'gold': 800, 'items': ['æ²™æ¼ ä¹‹é´']},
                        'level_requirement': 10,
                        'type': 'escort'
                    },
                    {
                        'title': 'å¯»æ‰¾å¤±è½çš„å•†é˜Ÿ',
                        'description': 'ä¸€æ”¯å•†é˜Ÿåœ¨æ²™æ¼ ä¸­å¤±è¸ªäº†ï¼Œè¯·æ‰¾åˆ°å®ƒã€‚',
                        'reward': {'exp': 220, 'gold': 1000, 'items': ['æ²™æ¼ ä¹‹ç›¾']},
                        'level_requirement': 16,
                        'type': 'search'
                    }
                ],
                'å‘å¯¼': [
                    {
                        'title': 'å¯»æ‰¾ç»¿æ´²',
                        'description': 'æ²™æ¼ ä¸­éœ€è¦æ–°çš„æ°´æºï¼Œè¯·æ‰¾åˆ°ä¸€ä¸ªæ–°çš„ç»¿æ´²ã€‚',
                        'reward': {'exp': 140, 'gold': 550, 'items': ['æ°´è¢‹']},
                        'level_requirement': 7,
                        'type': 'exploration'
                    }
                ]
            },
            'åœ°ç‰¢': {
                'å®ˆå«': [
                    {
                        'title': 'æ‰æ‹¿é€ƒçŠ¯',
                        'description': 'åœ°ç‰¢ä¸­æœ‰å›šçŠ¯é€ƒè·‘äº†ï¼Œè¯·å°†ä»–ä»¬æŠ“å›æ¥ã€‚',
                        'reward': {'exp': 160, 'gold': 650, 'items': ['é”é“¾']},
                        'level_requirement': 9,
                        'type': 'capture'
                    }
                ],
                'æ³•å¸ˆ': [
                    {
                        'title': 'æ”¶é›†çµé­‚çŸ³',
                        'description': 'æˆ‘éœ€è¦ä¸€äº›çµé­‚çŸ³æ¥å¢å¼ºæˆ‘çš„é­”æ³•ï¼Œè¯·æ”¶é›†8ä¸ªçµé­‚çŸ³ã€‚',
                        'reward': {'exp': 200, 'gold': 900, 'items': ['é­”æ³•ä¹¦']},
                        'level_requirement': 14,
                        'type': 'collection'
                    }
                ]
            }
        }
        
        # æ ¹æ®åœ°å›¾ç±»å‹å’ŒNPCç±»å‹è·å–é€‚åˆçš„ä»»åŠ¡
        if self.map_type in quests:
            if self.npc_type in quests[self.map_type]:
                available_quests = quests[self.map_type][self.npc_type]
                # ç­›é€‰ç©å®¶ç­‰çº§å¯ä»¥æ¥å—çš„ä»»åŠ¡
                suitable_quests = [quest for quest in available_quests if quest['level_requirement'] <= player_level]
                if suitable_quests:
                    # ä¼˜å…ˆé€‰æ‹©ç­‰çº§è¦æ±‚æœ€æ¥è¿‘ç©å®¶ç­‰çº§çš„ä»»åŠ¡
                    suitable_quests.sort(key=lambda x: x['level_requirement'], reverse=True)
                    return suitable_quests[0]
        
        # é»˜è®¤ä»»åŠ¡
        return {
            'title': 'æ¢ç´¢ä¸–ç•Œ',
            'description': 'å‹‡æ•¢åœ°æ¢ç´¢è¿™ä¸ªä¸–ç•Œï¼Œå˜å¾—æ›´åŠ å¼ºå¤§ã€‚',
            'reward': {'exp': 50, 'gold': 100, 'items': ['é‡‘ç–®è¯']},
            'level_requirement': 1,
            'type': 'exploration'
        }
    
    def trade(self, player, item_name, quantity=1):
        """ä¸ç©å®¶äº¤æ˜“"""
        if not self.has_shop:
            return False, 'æˆ‘æ²¡æœ‰å•†åº—'
        
        # æŸ¥æ‰¾å•†å“
        for item in self.shop_items:
            if item['name'] == item_name and item['quantity'] >= quantity:
                # è®¡ç®—ä»·æ ¼
                total_price = item['price'] * quantity
                # æ£€æŸ¥ç©å®¶æ˜¯å¦æœ‰è¶³å¤Ÿçš„é‡‘å¸
                if getattr(player, 'gold', 0) >= total_price:
                    # æ‰£é™¤ç©å®¶é‡‘å¸
                    player.gold -= total_price
                    # å‡å°‘å•†å“æ•°é‡
                    item['quantity'] -= quantity
                    # ç»™ç©å®¶ç‰©å“
                    if not hasattr(player, 'inventory'):
                        player.inventory = []
                    # æ·»åŠ ç‰©å“åˆ°ç©å®¶èƒŒåŒ…
                    for i in range(quantity):
                        player.inventory.append({'name': item_name, 'type': 'consumable' if 'è¯' in item_name else 'weapon'})
                    return True, f'è´­ä¹°æˆåŠŸï¼èŠ±è´¹äº†{total_price}é‡‘å¸'
                else:
                    return False, 'é‡‘å¸ä¸è¶³'
        return False, 'å•†å“ä¸å­˜åœ¨æˆ–æ•°é‡ä¸è¶³'
    
    def teach_skill(self, player, skill_name):
        """ä¼ æˆæŠ€èƒ½ç»™ç©å®¶"""
        # æŠ€èƒ½æ•°æ®åº“
        skills = {
            'æ³•å¸ˆ': [
                {'name': 'ç«çƒæœ¯', 'description': 'å‘å°„ä¸€ä¸ªç«çƒæ”»å‡»æ•Œäºº', 'cost': 500, 'level_requirement': 5},
                {'name': 'å†°ç®­æœ¯', 'description': 'å‘å°„ä¸€æ”¯å†°ç®­æ”»å‡»æ•Œäºº', 'cost': 600, 'level_requirement': 8},
                {'name': 'é—ªç”µæœ¯', 'description': 'é‡Šæ”¾é—ªç”µæ”»å‡»æ•Œäºº', 'cost': 800, 'level_requirement': 12},
                {'name': 'é­”æ³•æŠ¤ç›¾', 'description': 'åˆ›é€ ä¸€ä¸ªé­”æ³•æŠ¤ç›¾ä¿æŠ¤è‡ªå·±', 'cost': 1000, 'level_requirement': 15}
            ],
            'æˆ˜å£«': [
                {'name': 'çŒ›å‡»', 'description': 'ç”¨åŠ›æ”»å‡»æ•Œäºº', 'cost': 400, 'level_requirement': 3},
                {'name': 'å†²é”‹', 'description': 'å¿«é€Ÿå†²å‘æ•Œäºº', 'cost': 500, 'level_requirement': 6},
                {'name': 'æ—‹é£æ–©', 'description': 'æ—‹è½¬æ”»å‡»å‘¨å›´çš„æ•Œäºº', 'cost': 700, 'level_requirement': 10},
                {'name': 'å˜²è®½', 'description': 'å¸å¼•æ•Œäººçš„æ³¨æ„åŠ›', 'cost': 800, 'level_requirement': 13}
            ],
            'é“å£«': [
                {'name': 'æ²»æ„ˆæœ¯', 'description': 'æ²»ç–—è‡ªå·±æˆ–é˜Ÿå‹', 'cost': 300, 'level_requirement': 2},
                {'name': 'éšèº«æœ¯', 'description': 'æš‚æ—¶éšèº«', 'cost': 500, 'level_requirement': 7},
                {'name': 'å¬å”¤éª·é«…', 'description': 'å¬å”¤ä¸€ä¸ªéª·é«…æˆ˜å£«', 'cost': 600, 'level_requirement': 11},
                {'name': 'ç¾¤ä½“æ²»æ„ˆ', 'description': 'æ²»ç–—å‘¨å›´çš„é˜Ÿå‹', 'cost': 900, 'level_requirement': 14}
            ]
        }
        
        # æ£€æŸ¥NPCæ˜¯å¦å¯ä»¥ä¼ æˆæŠ€èƒ½
        if self.npc_type not in ['æ³•å¸ˆ', 'æˆ˜å£«', 'é“å£«', 'æ•™å¸ˆ']:
            return False, 'æˆ‘ä¸ä¼šä¼ æˆæŠ€èƒ½'
        
        # æ£€æŸ¥ç©å®¶èŒä¸šæ˜¯å¦æœ‰å¯¹åº”æŠ€èƒ½
        if player.èŒä¸š not in skills:
            return False, 'ä½ çš„èŒä¸šæ²¡æœ‰å¯å­¦ä¹ çš„æŠ€èƒ½'
        
        # æŸ¥æ‰¾æŠ€èƒ½
        for skill in skills[player.èŒä¸š]:
            if skill['name'] == skill_name:
                # æ£€æŸ¥ç©å®¶ç­‰çº§
                if player.level < skill['level_requirement']:
                    return False, f'ç­‰çº§ä¸è¶³ï¼Œéœ€è¦{skill["level_requirement"]}çº§'
                # æ£€æŸ¥ç©å®¶æ˜¯å¦æœ‰è¶³å¤Ÿçš„é‡‘å¸
                if getattr(player, 'gold', 0) < skill['cost']:
                    return False, 'é‡‘å¸ä¸è¶³'
                # æ£€æŸ¥ç©å®¶æ˜¯å¦å·²ç»å­¦ä¼šäº†è¿™ä¸ªæŠ€èƒ½
                if not hasattr(player, 'skills'):
                    player.skills = []
                if any(s['name'] == skill_name for s in player.skills):
                    return False, 'ä½ å·²ç»å­¦ä¼šäº†è¿™ä¸ªæŠ€èƒ½'
                # æ‰£é™¤é‡‘å¸
                player.gold -= skill['cost']
                # å­¦ä¹ æŠ€èƒ½
                player.skills.append({
                    'name': skill_name,
                    'description': skill['description'],
                    'level': 1,
                    'max_level': 10
                })
                return True, f'å­¦ä¼šäº†{skill_name}ï¼'
        
        return False, 'æŠ€èƒ½ä¸å­˜åœ¨'
    
    def repair_equipment(self, player, equipment_name):
        """ä¿®ç†è£…å¤‡"""
        if self.npc_type not in ['é“åŒ ', 'é˜²å…·å•†']:
            return False, 'æˆ‘ä¸ä¼šä¿®ç†è£…å¤‡'
        
        # æ£€æŸ¥ç©å®¶æ˜¯å¦æœ‰è¯¥è£…å¤‡
        if not hasattr(player, 'equipment'):
            return False, 'ä½ æ²¡æœ‰è£…å¤‡'
        
        # æŸ¥æ‰¾è£…å¤‡
        for equipment in player.equipment:
            if equipment['name'] == equipment_name:
                # è®¡ç®—ä¿®ç†è´¹ç”¨
                repair_cost = equipment.get('price', 100) // 2
                # æ£€æŸ¥ç©å®¶æ˜¯å¦æœ‰è¶³å¤Ÿçš„é‡‘å¸
                if getattr(player, 'gold', 0) < repair_cost:
                    return False, 'é‡‘å¸ä¸è¶³'
                # æ‰£é™¤é‡‘å¸
                player.gold -= repair_cost
                # ä¿®å¤è£…å¤‡è€ä¹…åº¦
                equipment['durability'] = equipment.get('max_durability', 100)
                return True, f'ä¿®ç†æˆåŠŸï¼èŠ±è´¹äº†{repair_cost}é‡‘å¸'
        
        return False, 'è£…å¤‡ä¸å­˜åœ¨'
    
    def heal(self, player):
        """æ²»ç–—ç©å®¶"""
        if self.npc_type not in ['ç‰§å¸ˆ', 'åŒ»ç”Ÿ', 'è¯åº—è€æ¿']:
            return False, 'æˆ‘ä¸ä¼šæ²»ç–—'
        
        # è®¡ç®—æ²»ç–—è´¹ç”¨
        heal_cost = max(50, (player.max_health - player.health) * 2)
        # æ£€æŸ¥ç©å®¶æ˜¯å¦æœ‰è¶³å¤Ÿçš„é‡‘å¸
        if getattr(player, 'gold', 0) < heal_cost:
            return False, 'é‡‘å¸ä¸è¶³'
        
        # æ‰£é™¤é‡‘å¸
        player.gold -= heal_cost
        # æ¢å¤ç©å®¶ç”Ÿå‘½å€¼
        player.health = player.max_health
        # æ¢å¤ç©å®¶é­”æ³•å€¼
        if hasattr(player, 'mana') and hasattr(player, 'max_mana'):
            player.mana = player.max_mana
        
        return True, f'æ²»ç–—æˆåŠŸï¼èŠ±è´¹äº†{heal_cost}é‡‘å¸ï¼Œç”Ÿå‘½å€¼å·²æ¢å¤æ»¡'